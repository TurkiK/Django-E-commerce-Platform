{% extends 'base.html' %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
    <div class="py-4 flex flex-col gap-10">
        <div class="flex flex-row text-sm gap-4 text-gray-400">
            <a href="{% url 'home' %}" class="hover:text-gray-700">Home</a>
            <span class="cursor-default">|</span>
            <a href="{% url 'products' category_name=product.category.name %}" class="hover:text-gray-700">{{ product.category.name }}</a>
            <span class="cursor-default">|</span>
            <a class="text-gray-700 font-bold" href="#">{{ product.name }}</a>
        </div>

        <div class="flex flex-row items-center justify-between gap-10 px-12 justify-items-start">
            <div class="flex flex-col w-1/2 gap-6">
                <div>
                    <img
                        class="rounded-md cursor-pointer hover:ring-2 hover:ring-gray-300 p-2"
                        src="https://prd.place/500/500?id={{product.id}}"
                        onclick="window.open('https://prd.place/500/500?id={{product.id}}')"
                    />
                </div>
                <div class="flex flex-row gap-4 w-full overflow-auto p-1">
                    <img class="rounded-md hover:ring-2 hover:ring-gray-300 cursor-pointer p-2" src="https://prd.place/75/75?id={{product.id}}">
                    <img class="rounded-md hover:ring-2 hover:ring-gray-300 cursor-pointer p-2" src="https://prd.place/75/75?id={{product.id}}">
                    <img class="rounded-md hover:ring-2 hover:ring-gray-300 cursor-pointer p-2" src="https://prd.place/75/75?id={{product.id}}">
                </div>
            </div>
            <div class="flex flex-col justify-between gap-4 w-1/2 self-start p-2">
                <div>
                    <div class="text-base">
                        <i class="fa-solid fa-star text-yellow-500"></i> 
                        <span class="pt-2">{{average_rating}} ({{reviews.count}})</span>
                    </div>
                    <h1 class="font-bold text-2xl mt-2">
                        {{ product.name }}
                    </h1>
                </div>
                <div class="border-t border-gray-300"></div>
                <div>
                    <h1 class="font-bold text-3xl text-indigo-500 mb-4">
                        ${{ product.price }}
                    </h1>
                    <div class="space-y-2">
                        <div class="flex flex-col mb-2">
                            <span class="font-bold">Description</span>
                            <p>{{ product.description }}</p>
                        </div>
                        <div class="flex flex-row gap-10">
                            <span class="font-bold">Stock</span>
                            <p id="stock">{{ product.stock }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-row justify-between gap-10">
            <div class="w-full">
                <!-- Features Section -->
                <div class="flex flex-row gap-10 cursor-default text-sm text-gray-700 justify-center">
                    <!-- Feature: Secure Marketplace -->
                    <div class="flex flex-row items-center gap-3">
                        <img src="https://www.svgrepo.com/show/18883/shield.svg" width="40" height="40">
                        <div>
                            <p class="font-bold">Secure</p>
                            <p>Receive product first</p>
                        </div>
                    </div>
                    <!-- Feature: Free Shipping -->
                    <div class="flex flex-row items-center gap-3">
                        <img src="https://www.svgrepo.com/show/445701/delivery-fast.svg" width="40" height="40">
                        <div>
                            <p class="font-bold">Free Shipping</p>
                            <p>Worldwide available</p>
                        </div>
                    </div>
                    <!-- Feature: Hassle-free Returns -->
                    <div class="flex flex-row items-center gap-3">
                        <img src="https://www.svgrepo.com/show/447761/return.svg" width="40" height="40">
                        <div>
                            <p class="font-bold">Return Available</p>
                            <p>See policy</p>
                        </div>
                    </div>
                </div>            
            </div>  

            <!--  -->
            <div class="flex w-full justify-center">
                <form class="flex flex-row justify-row gap-4" action="{% url 'add_to_cart' pk=product.pk %}" method="post">
                    {% csrf_token %}
                    <i  onclick="decrease()" class="fa-solid fa-minus rounded-full hover:bg-gray-300 transition duration-150 ease-in-out self-center cursor-pointer p-2"></i>
                    <input type="number" name="quantity" id="quantity" value="1" min="1" max="{{product.stock}}"
                        class="rounded ring-2 ring-gray-300 place-self-center text-center"
                    >
                    <i  onclick="increase()" class="fa-solid fa-plus rounded-full hover:bg-gray-300 transition duration-150 ease-in-out self-center cursor-pointer p-2"></i>
                    <input class="bg-indigo-500 rounded-md justify-center py-2 px-6 font-bold text-base text-white hover:bg-indigo-300 transition duration-150 ease-in-out cursor-pointer" type="submit" value="Add to Cart">
                </form>
            </div>
        </div>
        <div class="border-t border-gray-300"></div>

        <!-- Reviews -->
        <div class="flex flex-col gap-4 px-6">
            <h1 class="font-bold text-base sm:text-lg md:text-2xl lg:text-4xl">Reviews</h1>
            <div class="pb-5">
                <form action="{% url 'rate_product' pk=product.pk %}" method="post">
                    {% csrf_token %}
                    <div class="flex flex-col gap-4">
                        <div class="flex flex-row gap-4">
                            <label for="rating">Rating</label>
                            <div class="flex flex-row">
                                <i class="rating fa-solid fa-star text-yellow-500 cursor-pointer hover:ring-2 hover:ring-yellow-500 rounded-full p-1 transition duration-150 ease-in-out" onclick="setRating(1)"></i>
                                <i class="rating fa-solid fa-star text-yellow-500 cursor-pointer hover:ring-2 hover:ring-yellow-500 rounded-full p-1 transition duration-150 ease-in-out" onclick="setRating(2)"></i>
                                <i class="rating fa-solid fa-star text-yellow-500 cursor-pointer hover:ring-2 hover:ring-yellow-500 rounded-full p-1 transition duration-150 ease-in-out" onclick="setRating(3)"></i>
                                <i class="rating fa-solid fa-star text-yellow-500 cursor-pointer hover:ring-2 hover:ring-yellow-500 rounded-full p-1 transition duration-150 ease-in-out" onclick="setRating(4)"></i>
                                <i class="rating fa-solid fa-star text-yellow-500 cursor-pointer hover:ring-2 hover:ring-yellow-500 rounded-full p-1 transition duration-150 ease-in-out" onclick="setRating(5)"></i>
                            </div>
                            <input type="hidden" name="rating" id="rating" value="5" min="1" max="5" required>
                            <script>
                                function setRating(value) {
                                    const stars = document.querySelectorAll('.rating');
                                    const ratingInput = document.getElementById('rating');
                                    ratingInput.value = value;
                                    stars.forEach((star, index) => {
                                        if (index < value) {
                                            star.classList.add('text-yellow-500');
                                        } else {
                                            star.classList.remove('text-yellow-500');
                                        }
                                    });
                                }
                            </script>
                        </div>
                        <div class="flex flex-row gap-4">
                            <label for="comment">Comment</label>
                            <textarea name="comment" id="comment" class="rounded-md ring-2 ring-gray-300 text-sm p-2"></textarea>
                        </div>
                        <div class="flex flex-row gap-4">
                            <input type="submit" value="Submit" class="bg-indigo-500 rounded-md justify-center py-2 px-6 font-bold text-base text-white hover:bg-indigo-300 transition duration-150 ease-in-out cursor-pointer">
                        </div>
                    </div>
                </form>
            </div>
            <div class="border-t border-gray-300"></div>
            <div class="flex flex-col gap-4">
                {% if reviews %}
                    {% for review in reviews %}
                        <div class="flex flex-col gap-3 ring-2 ring-gray-200 rounded-md p-4">
                            <!-- User section -->
                            <div class="flex flex-row gap-4 cursor-default">
                                <div class="rounded-full bg-gray-200 p-4">
                                    <span class="p-2">{{ review.user.username|first }}</span>
                                </div>
                                <div class="flex flex-col justify-center">
                                    <p class="font-bold">{{ review.user.username }}</p>
                                    <p class="font-medium text-gray-400">{{ review.created_at }}</p>
                                </div>
                            </div>

                            <!-- Rating section -->
                            <div class="flex flex-row gap-2 cursor-default">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= review.rating %}
                                        <i class="fa-solid fa-star text-yellow-500"></i>
                                    {% else %}
                                        <i class="fa-solid fa-star text-gray-300"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <!-- Comment section -->
                            <div>
                                <p>{{ review.comment }}</p>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <span class="font-semibold text-lg text-center my-10">No reviews yet.</span>
                {% endif %}
            </div>
        </div>
    </div>
    <script>
        stock = document.getElementById("stock");
        quantity = document.getElementByName("quantity");
        function increase(){
            quantity.value++;
        }

        function decrease(){
            if(quantity.value > 1)
                quantity.value--;
        }
    </script>
{% endblock %}
